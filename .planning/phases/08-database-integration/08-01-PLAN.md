---
phase: 08-database-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [04-migrate-project.sh]
autonomous: true

must_haves:
  truths:
    - "Script creates PostgreSQL database with sanitized project name (hyphens become underscores)"
    - "Script detects Prisma projects by presence of prisma/schema.prisma and runs prisma migrate deploy"
    - "Script detects Drizzle projects by presence of drizzle.config.* and runs drizzle-kit push --force"
    - "Script detects raw SQL migrations in migrations/*.sql and runs them in alphabetical order"
    - "DATABASE_URL is generated and appended to .env if not already present"
    - "Database creation is idempotent (re-running does not fail)"
  artifacts:
    - path: "04-migrate-project.sh"
      provides: "Database name sanitization function"
      contains: "sanitize_db_name"
    - path: "04-migrate-project.sh"
      provides: "Database creation function"
      contains: "create_project_database"
    - path: "04-migrate-project.sh"
      provides: "Migration tool detection function"
      contains: "detect_migration_tool"
    - path: "04-migrate-project.sh"
      provides: "Migration execution functions"
      contains: "run_prisma_migrations"
    - path: "04-migrate-project.sh"
      provides: "DATABASE_URL generation and .env update"
      contains: "append_database_url"
  key_links:
    - from: "04-migrate-project.sh"
      to: "PostgreSQL via sudo -u postgres"
      via: "createdb and psql commands inside container"
      pattern: "sudo -u postgres"
    - from: "04-migrate-project.sh"
      to: "setup_database function"
      via: "called after setup_nodejs_dependencies in transfer_project"
      pattern: "setup_database"
    - from: "04-migrate-project.sh"
      to: "NVM_DIR/nvm.sh"
      via: "source nvm before npx prisma/drizzle-kit commands"
      pattern: "NVM_DIR.*nvm\\.sh"
---

<objective>
Add database creation and migration execution to the project migration script

Purpose: After Phase 7 installs Node.js dependencies, the database must be created and migrations run so projects can connect to PostgreSQL immediately. This completes the automated project setup pipeline.

Output: Extended 04-migrate-project.sh with database name sanitization, PostgreSQL database creation, migration tool detection (Prisma/Drizzle/SQL), migration execution, and DATABASE_URL injection into .env
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-database-integration/08-RESEARCH.md
@.planning/phases/07-nodejs-setup/07-01-SUMMARY.md
@04-migrate-project.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database helper functions</name>
  <files>04-migrate-project.sh</files>
  <action>
Add a new section "Database Setup Functions" after the "Node.js Setup Orchestration" section but before "Transfer Functions". Add these functions:

1. `sanitize_db_name()` - Takes project_name as argument
   - Convert to lowercase with `tr '[:upper:]' '[:lower:]'`
   - Replace hyphens and dots with underscores: `tr '.-' '_'`
   - Remove any character that's not alphanumeric or underscore: `tr -cd 'a-z0-9_'`
   - If starts with digit, prefix with 'db_': `[[ "$sanitized" =~ ^[0-9] ]] && sanitized="db_${sanitized}"`
   - Truncate to 63 chars (PostgreSQL limit): `${sanitized:0:63}`
   - Echo the sanitized name

2. `create_project_database()` - Takes db_name as argument
   - Check if database exists first (idempotent): `sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='$db_name'" | grep -q 1`
   - If exists, log info and return 0
   - If not, create with: `sudo -u postgres createdb -O dev "$db_name"`
   - Install pgcrypto extension: `sudo -u postgres psql -d "$db_name" -c 'CREATE EXTENSION IF NOT EXISTS pgcrypto;'`
   - Log success

3. `generate_database_url()` - Takes db_name as argument
   - Format: `postgresql://dev:dev@localhost:5432/${db_name}`
   - Echo the URL

4. `append_database_url_to_env()` - Takes project_dir and database_url as arguments
   - Touch .env file (create if not exists)
   - Check if DATABASE_URL already exists in .env: `grep -qF 'DATABASE_URL=' "$env_file"`
   - If exists, log and skip
   - If not, append: `echo "DATABASE_URL=\"${database_url}\"" >> "$env_file"`
   - Log what was done

CRITICAL: All PostgreSQL commands run inside the container via container_exec. Use:
```bash
container_exec "
    if sudo -u postgres psql -tAc \"SELECT 1 FROM pg_database WHERE datname='$db_name'\" | grep -q 1; then
        echo 'Database exists'
    else
        sudo -u postgres createdb -O dev '$db_name'
    fi
"
```
  </action>
  <verify>
Read 04-migrate-project.sh and confirm:
- sanitize_db_name function exists with tr commands and digit prefix handling
- create_project_database function exists with existence check and createdb
- generate_database_url function exists returning postgresql:// URL
- append_database_url_to_env function exists with grep -qF check
- Section comment "# Database Setup Functions" exists
  </verify>
  <done>Four database helper functions exist in 04-migrate-project.sh</done>
</task>

<task type="auto">
  <name>Task 2: Add migration detection and execution functions</name>
  <files>04-migrate-project.sh</files>
  <action>
Add migration functions after the database helper functions:

1. `detect_migration_tool()` - Takes project_dir as argument
   - Check inside container using lxc exec tests
   - Prisma first (most specific): `test -f "$project_dir/prisma/schema.prisma"`
   - Drizzle second: `test -f "$project_dir/drizzle.config.ts"` or `.js` or `.mjs`, or `test -d "$project_dir/drizzle"`
   - Raw SQL third: `test -d "$project_dir/migrations"` AND `find "$project_dir/migrations" -maxdepth 1 -name "*.sql" | wc -l` > 0
   - Echo "prisma", "drizzle", "sql", or "none"

2. `run_prisma_migrations()` - Takes project_dir and database_url as arguments
   - Source nvm.sh (CRITICAL for npx access)
   - cd to project_dir
   - Run: `DATABASE_URL="$database_url" npx prisma migrate deploy`
   - Log completion

3. `run_drizzle_migrations()` - Takes project_dir and database_url as arguments
   - Source nvm.sh (CRITICAL for npx access)
   - cd to project_dir
   - Run: `DATABASE_URL="$database_url" npx drizzle-kit push --force`
   - Note: --force auto-accepts data-loss statements (appropriate for dev environment)
   - Log completion

4. `run_sql_migrations()` - Takes project_dir and db_name as arguments
   - Find all .sql files in migrations/ directory
   - Sort alphabetically (ensures 001_init.sql runs before 002_users.sql)
   - For each file, run: `sudo -u postgres psql -d "$db_name" -v ON_ERROR_STOP=1 -1 -f "$sql_file"`
   - Note: -1 wraps in transaction, ON_ERROR_STOP fails fast on errors
   - Log each file as it runs

CRITICAL: Prisma and Drizzle migrations must:
1. Source nvm.sh: `export NVM_DIR="\$HOME/.nvm" && [ -s "\$NVM_DIR/nvm.sh" ] && \\. "\$NVM_DIR/nvm.sh"`
2. Set DATABASE_URL as environment variable for the command
3. Run inside container via container_exec

Example for Prisma:
```bash
container_exec "
    export NVM_DIR=\"\$HOME/.nvm\"
    [ -s \"\$NVM_DIR/nvm.sh\" ] && \\. \"\$NVM_DIR/nvm.sh\"
    cd '$project_dir'
    DATABASE_URL='$database_url' npx prisma migrate deploy
"
```
  </action>
  <verify>
Read 04-migrate-project.sh and confirm:
- detect_migration_tool function exists with prisma/drizzle/sql/none detection
- run_prisma_migrations function exists with nvm sourcing and prisma migrate deploy
- run_drizzle_migrations function exists with nvm sourcing and drizzle-kit push --force
- run_sql_migrations function exists with find | sort | psql -f pattern
- All migration functions log what they're doing
  </verify>
  <done>Migration detection and execution functions exist with correct tool-specific commands</done>
</task>

<task type="auto">
  <name>Task 3: Add setup_database orchestration and integrate into transfer_project</name>
  <files>04-migrate-project.sh</files>
  <action>
Add orchestration function and integrate into main flow:

1. Add `setup_database()` orchestration function after the migration functions:
```bash
# Main database setup orchestration
setup_database() {
    local project_dir="$1"
    local project_name
    project_name=$(basename "$project_dir")

    log_info "=== Database Setup ==="

    # Step 1: Sanitize project name for PostgreSQL
    local db_name
    db_name=$(sanitize_db_name "$project_name")
    log_info "Database name: $db_name"

    # Step 2: Create database if not exists
    create_project_database "$db_name"

    # Step 3: Generate DATABASE_URL
    local database_url
    database_url=$(generate_database_url "$db_name")

    # Step 4: Append DATABASE_URL to .env
    append_database_url_to_env "$project_dir" "$database_url"

    # Step 5: Detect and run migrations
    local migration_tool
    migration_tool=$(detect_migration_tool "$project_dir")
    log_info "Detected migration tool: $migration_tool"

    case "$migration_tool" in
        prisma)
            run_prisma_migrations "$project_dir" "$database_url"
            ;;
        drizzle)
            run_drizzle_migrations "$project_dir" "$database_url"
            ;;
        sql)
            run_sql_migrations "$project_dir" "$db_name"
            ;;
        none)
            log_info "No migration tool detected, skipping migrations"
            ;;
    esac

    log_info "Database setup complete"
}
```

2. Integrate into transfer_project() function:
   - After the `setup_nodejs_dependencies "$dest_dir"` call
   - Add: `setup_database "$dest_dir"`
   - This ensures database is created AFTER dependencies are installed (Prisma/Drizzle CLIs need to be installed first)

3. Update the script header comment to mention database setup:
   - Add to Features list: "Creates PostgreSQL database with sanitized project name"
   - Add to Features list: "Runs database migrations (Prisma, Drizzle, or raw SQL)"
   - Add to Features list: "Appends DATABASE_URL to .env if not present"

4. Run `bash -n 04-migrate-project.sh` to verify no syntax errors
  </action>
  <verify>
- `bash -n 04-migrate-project.sh` exits 0 (no syntax errors)
- setup_database function exists and orchestrates all database steps
- transfer_project function calls setup_database after setup_nodejs_dependencies
- Script header mentions database creation and migrations
- All requirements covered:
  - DB-01: sanitize_db_name + createdb creates database with sanitized name
  - DB-02: detect_migration_tool checks for prisma/schema.prisma
  - DB-03: detect_migration_tool checks for drizzle.config.* and drizzle/
  - DB-04: run_prisma_migrations runs prisma migrate deploy
  - DB-05: run_drizzle_migrations runs drizzle-kit push --force
  - DB-06: detect_migration_tool checks migrations/*.sql
  - DB-07: run_sql_migrations sorts and runs SQL files
  - ENV-03: generate_database_url creates postgresql:// URL
  - ENV-04: append_database_url_to_env adds to .env
  </verify>
  <done>Database setup orchestration complete and integrated into migration flow</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Script syntax valid:
   ```bash
   bash -n 04-migrate-project.sh
   ```

2. Database functions exist:
   ```bash
   grep -E "^(sanitize_db_name|create_project_database|generate_database_url|append_database_url_to_env|detect_migration_tool|run_prisma_migrations|run_drizzle_migrations|run_sql_migrations|setup_database)\(\)" 04-migrate-project.sh
   ```
   Should return 9 function definitions

3. PostgreSQL commands present:
   ```bash
   grep "sudo -u postgres" 04-migrate-project.sh | head -5
   ```

4. NVM sourcing in migration functions:
   ```bash
   grep -A5 "run_prisma_migrations\|run_drizzle_migrations" 04-migrate-project.sh | grep "NVM_DIR"
   ```

5. All requirements covered:
   - DB-01: grep "createdb" returns match
   - DB-02: grep "schema.prisma" returns match
   - DB-03: grep "drizzle.config" returns match
   - DB-04: grep "prisma migrate deploy" returns match
   - DB-05: grep "drizzle-kit push" returns match
   - DB-06: grep "migrations.*\\.sql" returns match
   - DB-07: grep "sort" in context of sql migrations
   - ENV-03: grep "postgresql://dev:dev@localhost:5432" returns match
   - ENV-04: grep "DATABASE_URL=" in append function
</verification>

<success_criteria>
- 04-migrate-project.sh extended with database setup (adds ~120 lines)
- Database name sanitization handles hyphens, dots, leading digits
- Database creation is idempotent (safe to re-run)
- Prisma projects run `prisma migrate deploy` with DATABASE_URL
- Drizzle projects run `drizzle-kit push --force` with DATABASE_URL
- Raw SQL migrations run in alphabetical order with ON_ERROR_STOP
- DATABASE_URL appended to .env only if not already present
- Script syntax valid (bash -n passes)
- All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-integration/08-01-SUMMARY.md`
</output>
