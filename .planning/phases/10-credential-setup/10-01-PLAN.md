# Plan: Credential Setup - Default Auth Copying

## Metadata

```yaml
plan_id: 10-01
phase: 10
wave: 1
depends_on: []
files_modified:
  - 03-provision-container.sh
  - sandbox.sh
  - CLAUDE.md
autonomous: true
```

## Objective

Make credential copying the default behavior during container provisioning. Remove the `--with-gh-creds` flag and ensure Claude Code and git credentials work out-of-the-box.

## Context

Currently:
- `copy_claude_credentials` runs unconditionally (good)
- `setup_git_credentials` only runs if `--with-gh-creds` flag is passed (needs to change)
- SSH known_hosts relies on host having them (may be empty)

## Tasks

### Task 1: Make git credential copying default

<task id="1" title="Remove --with-gh-creds conditional">

**File:** `03-provision-container.sh`

1. Remove the `if [[ "$WITH_GH_CREDS" == true ]]` check around `setup_git_credentials` call (around line 1135)
2. Make `setup_git_credentials` run unconditionally after `setup_ssh_keys`
3. Remove `WITH_GH_CREDS` variable initialization (line 59)
4. Remove `--with-gh-creds)` case from argument parsing (lines 69-72)
5. Remove `--with-gh-creds` from help text (lines 43, 52)

**Verification:** The function call should be unconditional:
```bash
setup_ssh_keys         # Copy host's authorized keys to root and dev
setup_git_credentials  # Copy SSH keys, .gitconfig, gh CLI for git push/pull
```

</task>

### Task 2: Ensure SSH known_hosts includes GitHub/GitLab

<task id="2" title="Add default SSH known_hosts entries">

**File:** `03-provision-container.sh`

In `setup_git_credentials` function, after copying known_hosts from host, add:

```bash
# Add GitHub and GitLab host keys if not already present
log_info "Ensuring GitHub and GitLab are in known_hosts..."
container_exec '
    if ! grep -q "github.com" /home/dev/.ssh/known_hosts 2>/dev/null; then
        ssh-keyscan -t ed25519,rsa github.com >> /home/dev/.ssh/known_hosts 2>/dev/null
    fi
    if ! grep -q "gitlab.com" /home/dev/.ssh/known_hosts 2>/dev/null; then
        ssh-keyscan -t ed25519,rsa gitlab.com >> /home/dev/.ssh/known_hosts 2>/dev/null
    fi
    chown dev:dev /home/dev/.ssh/known_hosts 2>/dev/null || true
    chmod 644 /home/dev/.ssh/known_hosts 2>/dev/null || true
'
```

This ensures git operations work even if host's known_hosts didn't include these.

</task>

### Task 3: Copy git credentials to root user too

<task id="3" title="Copy git credentials to root user">

**File:** `03-provision-container.sh`

Currently `setup_git_credentials` only copies to `/home/dev`. Add parallel copying to `/root` for consistency (root may also run git commands).

After copying to dev user, add equivalent operations for root:
- SSH keys to `/root/.ssh/`
- `.gitconfig` to `/root/`
- gh CLI config to `/root/.config/gh/`

</task>

### Task 4: Update sandbox.sh CLI

<task id="4" title="Remove --with-gh-creds from sandbox.sh">

**File:** `sandbox.sh`

1. Update help text in `show_help` function (line 39) - remove `[--with-gh-creds]`
2. Remove the for loop checking for `--with-gh-creds` in `cmd_create` function (lines 74-79)
3. Remove `$extra_opts` variable and its usage
4. Update usage text in `cmd_create` (lines 82-87)

</task>

### Task 5: Update CLAUDE.md documentation

<task id="5" title="Update CLAUDE.md">

**File:** `CLAUDE.md`

1. Remove references to `--with-gh-creds` flag
2. Update "Create New Sandbox" section to show credential copying is default
3. Note that Claude Code and git credentials are automatically copied from host

</task>

### Task 6: Update summary output

<task id="6" title="Update provisioning summary">

**File:** `03-provision-container.sh`

1. Remove the `if [[ "$WITH_GH_CREDS" == true ]]` check in the summary section (around line 1073)
2. Always show git credentials status in summary
3. Update wording to indicate this is default behavior

</task>

## Verification Criteria

After implementation:

1. **Functional:** Run `./sandbox.sh create test tskey-xxx` without `--with-gh-creds` and verify:
   - `~/.claude/` exists in container for both root and dev
   - `~/.ssh/` keys exist for both users
   - `~/.config/gh/` exists for both users (if host has it)
   - `~/.ssh/known_hosts` includes github.com and gitlab.com

2. **CLI:** Verify `--with-gh-creds` is no longer accepted:
   - `./sandbox.sh --help` doesn't mention it
   - `./03-provision-container.sh --help` doesn't mention it

3. **Code review:**
   - No remaining references to `WITH_GH_CREDS` variable
   - No remaining references to `--with-gh-creds` flag

## Must Haves

These must be TRUE after execution:

1. `setup_git_credentials` runs unconditionally during provisioning
2. SSH known_hosts includes github.com and gitlab.com entries
3. Git credentials copied to both root and dev users
4. `--with-gh-creds` flag completely removed from codebase
5. CLAUDE.md reflects default credential copying behavior

## Commit Message

```
feat: make credential copying default during container creation

- Remove --with-gh-creds flag (git credentials now copied by default)
- Add github.com and gitlab.com to SSH known_hosts automatically
- Copy git credentials to both root and dev users
- Update documentation to reflect new default behavior

Closes: CLAUDE-01, CLAUDE-02, CLAUDE-03, GIT-01, GIT-02, GIT-03, GIT-04, GIT-05, DEV-01, DEV-02
```
