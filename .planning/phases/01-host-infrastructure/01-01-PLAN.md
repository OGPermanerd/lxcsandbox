---
phase: 01-host-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 01-setup-host.sh
autonomous: true

must_haves:
  truths:
    - "Script detects Ubuntu 22.04 or 24.04 and exits with clear error on unsupported versions"
    - "Script verifies SSH connectivity before making any network changes"
    - "Script installs LXD via snap if not already installed"
    - "Script creates lxdbr0 bridge with NAT enabled (or accepts existing)"
    - "Script creates btrfs storage pool (or accepts existing)"
    - "Script adds UFW rules for lxdbr0 without modifying existing rules"
    - "Script is fully idempotent - safe to run multiple times"
  artifacts:
    - path: "01-setup-host.sh"
      provides: "Complete host infrastructure setup script"
      contains: "lxd init --preseed"
  key_links:
    - from: "01-setup-host.sh"
      to: "lxd preseed"
      via: "heredoc piped to lxd init --preseed"
      pattern: "cat.*<<.*EOF.*lxd init --preseed"
---

<objective>
Rewrite 01-setup-host.sh to be production-ready: fully idempotent, safe (SSH/Tailscale protection), and complete (all HOST-* requirements).

Purpose: Create a reliable host setup script that can be run on any Ubuntu 22.04/24.04 VPS to prepare it for LXC container hosting. The script must never break SSH or Tailscale access.
Output: Working 01-setup-host.sh that satisfies HOST-01 through HOST-06.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-host-infrastructure/01-CONTEXT.md
@.planning/phases/01-host-infrastructure/01-RESEARCH.md
@01-setup-host.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite detection and prerequisite installation</name>
  <files>01-setup-host.sh</files>
  <action>
Rewrite the first half of 01-setup-host.sh to handle detection and prerequisites:

1. **Script header and safety**:
   - Keep `set -euo pipefail` for fail-fast behavior
   - Add `trap` for clean error messages on failure
   - Remove the interactive Tailscale prompt (not needed for host setup)

2. **Ubuntu version detection (HOST-01)**:
   - Parse `/etc/os-release` for VERSION_ID
   - Accept only 22.04 or 24.04
   - Exit with clear error message on unsupported versions
   - Log the detected version

3. **SSH safety verification**:
   - Check if `$SSH_CONNECTION` is set (running via SSH)
   - If set, log confirmation that SSH connectivity is verified
   - If not set (local/console), proceed with warning
   - This is a pre-network-change safety check per CONTEXT.md

4. **Prerequisite installation**:
   - Install `snapd` if not present (needed for LXD)
   - Install `btrfs-progs` if not present (needed before preseed - see RESEARCH.md pitfall)
   - Make these idempotent: check `command -v` before installing

5. **LXD installation (HOST-02)**:
   - Check if LXD already installed via `snap list lxd`
   - If installed: log version, optionally run `snap refresh lxd`
   - If not installed: `snap install lxd`
   - Add current user to lxd group if not already member
   - Note about logout/login for group to take effect

Use the patterns from RESEARCH.md section "Installing LXD with Version Check".
  </action>
  <verify>
Run shellcheck on the script:
```bash
shellcheck 01-setup-host.sh
```
Should pass with no errors (warnings acceptable for intentional patterns).
  </verify>
  <done>
Script has: Ubuntu version validation with 22.04/24.04 check, SSH safety verification, snapd installation, btrfs-progs installation, LXD snap installation with idempotency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement LXD initialization and UFW configuration</name>
  <files>01-setup-host.sh</files>
  <action>
Complete the second half of 01-setup-host.sh:

1. **LXD initialization with preseed (HOST-03, HOST-04, HOST-05)**:
   - Check existing state first using patterns from RESEARCH.md:
     - `lxc storage list --format csv` to check for storage pool
     - `lxc network list --format csv` to check for lxdbr0
   - If both exist: log "already initialized", skip preseed
   - If either missing: apply preseed config

   Preseed YAML (from RESEARCH.md):
   ```yaml
   config: {}
   networks:
   - name: lxdbr0
     type: bridge
     config:
       ipv4.address: 10.10.10.1/24
       ipv4.nat: "true"
       ipv6.address: none
   storage_pools:
   - name: default
     driver: btrfs
     config:
       size: 20GB
   profiles:
   - name: default
     config: {}
     devices:
       eth0:
         name: eth0
         network: lxdbr0
         type: nic
       root:
         path: /
         pool: default
         type: disk
   ```

2. **UFW configuration (HOST-06)**:
   - Check if UFW is active: `ufw status | grep -q "Status: active"`
   - If not active: skip UFW rules (user hasn't enabled it)
   - If active: add rules (UFW skips duplicates automatically):
     - `ufw allow in on lxdbr0`
     - `ufw route allow in on lxdbr0`
     - `ufw route allow out on lxdbr0`
   - Do NOT run `ufw --force enable` (don't enable if not already enabled)
   - Do NOT modify existing rules (additive only per CONTEXT.md)

3. **Verification section**:
   - Verify LXD is running: `snap services lxd`
   - Verify storage pool exists: `lxc storage list`
   - Verify network exists: `lxc network show lxdbr0`
   - Verify NAT is enabled: `lxc network get lxdbr0 ipv4.nat`
   - Display summary with clear success/failure indicators

4. **Remove unnecessary parts**:
   - Remove the "Install useful host tools" section (apt packages)
   - Remove the interactive Tailscale prompt
   - Remove the helper directories creation
   - Keep the script focused on LXD infrastructure only
  </action>
  <verify>
Run the verification function in isolation (dry-run style):
```bash
# Check script syntax
bash -n 01-setup-host.sh

# Run shellcheck
shellcheck 01-setup-host.sh
```
Both should pass without errors.
  </verify>
  <done>
Script has: Idempotent LXD preseed initialization with state detection, UFW additive rules (only if UFW active), verification section that checks all components. All HOST-* requirements covered.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Syntax validation**:
   ```bash
   bash -n 01-setup-host.sh && echo "Syntax OK"
   shellcheck 01-setup-host.sh
   ```

2. **Requirements coverage check**:
   - HOST-01: grep for VERSION_ID and version check logic
   - HOST-02: grep for "snap install lxd"
   - HOST-03: grep for "lxdbr0" and "10.10.10"
   - HOST-04: grep for "ipv4.nat"
   - HOST-05: grep for "driver: btrfs"
   - HOST-06: grep for "ufw allow" and "lxdbr0"

3. **Safety checks**:
   - Confirm no `ufw --force enable` (don't auto-enable)
   - Confirm SSH_CONNECTION check exists
   - Confirm existing state detection before preseed
</verification>

<success_criteria>
- 01-setup-host.sh passes `bash -n` syntax check
- 01-setup-host.sh passes shellcheck with no errors
- All 6 HOST-* requirements have corresponding implementation
- Script is fully idempotent (detects existing state)
- Script verifies SSH before network changes
- Script does NOT contain interactive prompts
- Script does NOT auto-enable UFW
</success_criteria>

<output>
After completion, create `.planning/phases/01-host-infrastructure/01-01-SUMMARY.md`
</output>
