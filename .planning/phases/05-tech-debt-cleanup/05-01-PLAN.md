---
phase: 05-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 02-create-container.sh
  - 03-provision-container.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "02-create-container.sh fails early with clear message if LXD not installed"
    - "03-provision-container.sh fails early with clear message if TUN device missing"
    - "03-provision-container.sh has no unused functions"
  artifacts:
    - path: "02-create-container.sh"
      provides: "LXD availability check"
      contains: "command -v lxc"
    - path: "03-provision-container.sh"
      provides: "TUN device validation, no dead code"
      contains: "/dev/net/tun"
  key_links:
    - from: "02-create-container.sh"
      to: "lxc command"
      via: "availability check before first lxc call"
      pattern: "command -v lxc"
    - from: "03-provision-container.sh"
      to: "/dev/net/tun"
      via: "validation before Tailscale install"
      pattern: "lxc exec.*cat /dev/net/tun\\|ls.*dev/net/tun"
---

<objective>
Fix minor tech debt items from v1.0 milestone audit

Purpose: Improve script robustness with defensive checks and remove dead code
Output: Cleaner, more defensive shell scripts that fail early with clear messages
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@02-create-container.sh
@03-provision-container.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LXD availability check to container creation script</name>
  <files>02-create-container.sh</files>
  <action>
Add a check after the argument handling section (around line 50, before validate_container_name is called) to verify LXD is installed and initialized:

1. Check `command -v lxc` exists
2. If not, print helpful error message with install instructions
3. Exit with code 1

Insert this code block after CONTAINER_NAME="$1" (line 50) and before the validate_container_name function definition:

```bash
# -------------------------------------------
# LXD Availability Check
# -------------------------------------------
if ! command -v lxc &>/dev/null; then
    log_error "LXD is not installed"
    echo ""
    echo "Install LXD first:"
    echo "  sudo snap install lxd"
    echo "  sudo lxd init"
    echo ""
    echo "Or run the host setup script:"
    echo "  ./01-setup-host.sh"
    exit 1
fi
```

Note: Place this AFTER CONTAINER_NAME assignment but BEFORE validate_container_name so the name validation still gets useful input before the LXD check.
  </action>
  <verify>
Run: `grep -n "command -v lxc" 02-create-container.sh`
Should find the new check. Also verify script still parses: `bash -n 02-create-container.sh`
  </verify>
  <done>
02-create-container.sh checks for lxc command availability before any LXD operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove unused run_with_spinner function and add TUN validation</name>
  <files>03-provision-container.sh</files>
  <action>
Two changes to this file:

1. REMOVE the unused `run_with_spinner()` function (lines 112-141 approximately):
   - Delete the entire function including the comment header
   - This function is defined but never called anywhere in the script

2. ADD TUN device validation before Tailscale installation:
   - Add a new function `validate_tun_device()` after the helper functions section
   - Call it at the start of `install_tailscale()` function

Add this validation function after `wait_for_apt_lock()` (around line 109):

```bash
# Validate TUN device exists in container (required for Tailscale)
validate_tun_device() {
    log_info "Checking TUN device availability..."

    if ! container_exec 'ls /dev/net/tun &>/dev/null'; then
        log_error "TUN device not found in container"
        echo ""
        echo "The container needs a TUN device for Tailscale."
        echo "This should have been configured by 02-create-container.sh"
        echo ""
        echo "To fix manually:"
        echo "  lxc config device add $CONTAINER_NAME tun unix-char path=/dev/net/tun"
        echo "  lxc restart $CONTAINER_NAME"
        exit 1
    fi

    log_info "TUN device available"
}
```

Then modify `install_tailscale()` to call it first:

```bash
install_tailscale() {
    log_info "Setting up Tailscale..."

    # Validate TUN device before proceeding
    validate_tun_device

    # ... rest of existing function unchanged ...
```
  </action>
  <verify>
1. Verify dead code removed: `grep -c "run_with_spinner" 03-provision-container.sh` should return 0
2. Verify TUN check added: `grep -n "validate_tun_device" 03-provision-container.sh` should find function and call
3. Verify script parses: `bash -n 03-provision-container.sh`
  </verify>
  <done>
- run_with_spinner function removed (0 matches in grep)
- validate_tun_device function added and called before Tailscale install
- Script parses without errors
  </done>
</task>

</tasks>

<verification>
Run these checks to verify all tech debt items addressed:

```bash
# 1. LXD check in 02-create-container.sh
grep "command -v lxc" 02-create-container.sh

# 2. No dead code in 03-provision-container.sh
grep -c "run_with_spinner" 03-provision-container.sh  # Should be 0

# 3. TUN validation in 03-provision-container.sh
grep "validate_tun_device" 03-provision-container.sh

# 4. Both scripts parse correctly
bash -n 02-create-container.sh && echo "02 OK"
bash -n 03-provision-container.sh && echo "03 OK"

# 5. All scripts still executable
ls -la *.sh | grep "^-rwx"
```
</verification>

<success_criteria>
1. 02-create-container.sh has LXD availability check before first lxc command
2. 03-provision-container.sh has no references to run_with_spinner (dead code removed)
3. 03-provision-container.sh validates TUN device before Tailscale installation
4. Both scripts parse without syntax errors (bash -n passes)
5. All scripts remain executable
</success_criteria>

<output>
After completion, create `.planning/phases/05-tech-debt-cleanup/05-01-SUMMARY.md`
</output>
