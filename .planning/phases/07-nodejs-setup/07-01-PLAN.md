---
phase: 07-nodejs-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [04-migrate-project.sh]
autonomous: true

must_haves:
  truths:
    - "Script detects pnpm from pnpm-lock.yaml and runs pnpm install"
    - "Script detects yarn from yarn.lock and runs yarn install"
    - "Script detects npm from package-lock.json and runs npm install"
    - "Script reads .nvmrc and installs/uses that Node version"
    - "node_modules directory exists after migration completes"
    - "If .env missing but .env.example exists, .env is created from it"
  artifacts:
    - path: "04-migrate-project.sh"
      provides: "Node.js dependency installation functions"
      contains: "detect_package_manager"
    - path: "04-migrate-project.sh"
      provides: "nvm integration for .nvmrc"
      contains: "nvm install"
    - path: "04-migrate-project.sh"
      provides: "env example fallback"
      contains: "env.example"
  key_links:
    - from: "04-migrate-project.sh"
      to: "nvm.sh"
      via: "source NVM_DIR/nvm.sh in container_exec"
      pattern: "NVM_DIR.*nvm\\.sh"
    - from: "04-migrate-project.sh"
      to: "transfer_project function"
      via: "calls setup_nodejs_dependencies after file transfer"
      pattern: "setup_nodejs_dependencies"
---

<objective>
Add Node.js dependency installation to the project migration script

Purpose: After Phase 6 transfers project files, dependencies must be installed with the correct package manager and Node version so projects are ready to run.

Output: Extended 04-migrate-project.sh with package manager detection, .nvmrc handling, dependency installation, and .env.example fallback
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nodejs-setup/07-RESEARCH.md
@04-migrate-project.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Node.js setup helper functions</name>
  <files>04-migrate-project.sh</files>
  <action>
Add four new functions to 04-migrate-project.sh after the existing "Helper Functions" section but before "Transfer Functions":

1. `detect_package_manager()` - Takes project_dir as argument
   - Check for pnpm-lock.yaml first (pnpm)
   - Check for yarn.lock second (yarn)
   - Check for package-lock.json third (npm)
   - Default to npm if no lockfile found
   - Echo the detected package manager name

2. `setup_node_version()` - Takes project_dir as argument
   - Source nvm.sh inside container (CRITICAL: non-interactive shells don't auto-load nvm)
   - Check if .nvmrc exists in project_dir
   - If exists: run `nvm install` and `nvm use` (let nvm read .nvmrc automatically)
   - Log the Node version being used

3. `install_dependencies()` - Takes project_dir and package_manager as arguments
   - Source nvm.sh (must re-source in each container_exec call)
   - cd to project directory
   - Run the appropriate install command based on package_manager
   - Verify node_modules directory exists after install
   - Return 1 if node_modules not created

4. `copy_env_example_if_needed()` - Takes project_dir as argument
   - Check if .env does NOT exist AND .env.example exists
   - If so, copy .env.example to .env
   - Log what was done

CRITICAL: All nvm commands must be wrapped in container_exec with:
```bash
export NVM_DIR="\$HOME/.nvm"
[ -s "\$NVM_DIR/nvm.sh" ] && \\. "\$NVM_DIR/nvm.sh"
```
This sources nvm in non-interactive shells. Without it, nvm commands fail.

Add a section comment: `# Node.js Setup Functions`
  </action>
  <verify>
Read 04-migrate-project.sh and confirm:
- detect_package_manager function exists with lockfile checks
- setup_node_version function exists with nvm sourcing
- install_dependencies function exists with case statement for npm/yarn/pnpm
- copy_env_example_if_needed function exists
- All container_exec calls source NVM_DIR/nvm.sh
  </verify>
  <done>Four Node.js setup functions exist in 04-migrate-project.sh with proper nvm sourcing</done>
</task>

<task type="auto">
  <name>Task 2: Add setup_nodejs_dependencies orchestration function</name>
  <files>04-migrate-project.sh</files>
  <action>
Add a new orchestration function `setup_nodejs_dependencies()` that combines all the helpers:

```bash
# Main Node.js setup orchestration
setup_nodejs_dependencies() {
    local project_dir="$1"

    log_info "=== Node.js Setup ==="

    # Step 1: .env.example fallback (before npm install may need env vars)
    copy_env_example_if_needed "$project_dir"

    # Step 2: Detect package manager
    local pm
    pm=$(detect_package_manager "$project_dir")
    log_info "Detected package manager: $pm"

    # Step 3: Handle .nvmrc if present
    setup_node_version "$project_dir"

    # Step 4: Install dependencies
    log_info "Installing dependencies..."
    if ! install_dependencies "$project_dir" "$pm"; then
        log_error "Dependency installation failed"
        return 1
    fi

    log_info "Node.js setup complete"
}
```

Then integrate into `transfer_project()`:
- After the case statement that handles git/local transfer
- After verifying dest_dir exists
- Before the "Transfer Complete" message
- Call: `setup_nodejs_dependencies "$dest_dir"`

Update the final success messages to reflect that dependencies are now installed:
- Change "Next steps" section to show project is ready
- Update "Migration phase 1 (file transfer) complete!" to "Migration complete!"
  </action>
  <verify>
Read 04-migrate-project.sh and confirm:
- setup_nodejs_dependencies function exists
- transfer_project function calls setup_nodejs_dependencies after file transfer
- Success messages reflect that dependencies are installed
  </verify>
  <done>setup_nodejs_dependencies orchestrates the full flow and is called from transfer_project</done>
</task>

<task type="auto">
  <name>Task 3: Verify implementation matches requirements</name>
  <files>04-migrate-project.sh</files>
  <action>
Review the complete script and verify each requirement is covered:

NODE-01: detect_package_manager checks lockfiles in order (pnpm > yarn > npm)
NODE-02: install_dependencies runs pnpm/yarn/npm install based on detection
NODE-03: setup_node_version sources nvm, runs nvm install/use when .nvmrc present
NODE-04: install_dependencies verifies node_modules exists
ENV-02: copy_env_example_if_needed handles .env.example fallback

Also verify:
- Script still works for both git and local sources
- Error handling is consistent with existing patterns
- All log messages use log_info/log_warn/log_error
- The script header comment is updated to mention dependency installation

If anything is missing or inconsistent, fix it.

Run `bash -n 04-migrate-project.sh` to verify no syntax errors.
  </action>
  <verify>
- `bash -n 04-migrate-project.sh` exits 0 (no syntax errors)
- All NODE-* and ENV-02 requirements have corresponding code
- Script header mentions dependency installation
- Usage examples are still accurate
  </verify>
  <done>Script passes syntax check and covers all Phase 7 requirements</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Script syntax valid:
   ```bash
   bash -n 04-migrate-project.sh
   ```

2. Key functions exist:
   ```bash
   grep -E "^(detect_package_manager|setup_node_version|install_dependencies|copy_env_example_if_needed|setup_nodejs_dependencies)\(\)" 04-migrate-project.sh
   ```

3. nvm sourcing present:
   ```bash
   grep -c "NVM_DIR" 04-migrate-project.sh  # Should be >= 3 (one per container_exec call)
   ```

4. All requirements covered:
   - NODE-01: grep "pnpm-lock.yaml\|yarn.lock\|package-lock.json" returns matches
   - NODE-02: grep "pnpm install\|yarn install\|npm install" returns matches
   - NODE-03: grep "nvm install" returns match
   - NODE-04: grep "node_modules" returns match (verification)
   - ENV-02: grep "env.example" returns match
</verification>

<success_criteria>
- 04-migrate-project.sh extended with Node.js setup (adds ~100 lines)
- Package manager detection works for pnpm, yarn, npm
- .nvmrc detection triggers nvm install/use
- node_modules verified after install
- .env.example copied to .env when .env missing
- Script syntax valid (bash -n passes)
- All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/07-nodejs-setup/07-01-SUMMARY.md`
</output>
