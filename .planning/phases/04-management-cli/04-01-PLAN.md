---
phase: 04-management-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sandbox.sh
autonomous: true

must_haves:
  truths:
    - "User can create sandbox with 'sandbox.sh create <name> <tailscale-key>'"
    - "User can open shell with 'sandbox.sh shell <name>'"
    - "User can list containers with 'sandbox.sh list'"
    - "User can create snapshots with 'sandbox.sh snapshot <name> [label]'"
    - "User can restore with auto-backup via 'sandbox.sh restore <name> <label>'"
    - "User can delete with optional snapshot via 'sandbox.sh delete <name>'"
    - "User can view details with 'sandbox.sh info <name>'"
  artifacts:
    - path: "sandbox.sh"
      provides: "Management CLI with all 7 commands"
      contains: "cmd_create.*cmd_delete.*cmd_restore.*cmd_shell.*cmd_list.*cmd_snapshot.*cmd_info"
  key_links:
    - from: "sandbox.sh cmd_create"
      to: "02-create-container.sh"
      via: "script delegation"
      pattern: '"\$SCRIPT_DIR/02-create-container.sh"'
    - from: "sandbox.sh cmd_create"
      to: "03-provision-container.sh"
      via: "script delegation"
      pattern: '"\$SCRIPT_DIR/03-provision-container.sh"'
---

<objective>
Update sandbox.sh to implement all management CLI commands per CONTEXT.md decisions.

Purpose: Provide user-friendly CLI wrapper for sandbox operations, matching the decisions made in /gsd:discuss-phase (argument-based create, auto-snapshot on restore, snapshot prompt on delete).

Output: Updated sandbox.sh with all 7 commands (create, shell, list, snapshot, restore, delete, info) fully functional per spec.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-management-cli/04-CONTEXT.md
@.planning/phases/04-management-cli/04-RESEARCH.md
@sandbox.sh
@02-create-container.sh
@03-provision-container.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update core command functions</name>
  <files>sandbox.sh</files>
  <action>
Update sandbox.sh with these changes per CONTEXT.md decisions:

**1. Add container existence validation helper:**
```bash
validate_container_exists() {
    local name="$1"
    if ! lxc info "$name" &>/dev/null; then
        echo "Error: Container '$name' does not exist"
        exit 1
    fi
}
```

**2. Update cmd_create to accept auth key as argument (not interactive):**
- Change signature to require both name and tailscale-key
- Usage: `sandbox.sh create <name> <tailscale-key>`
- Remove `read -p` for auth key
- Validate both arguments present before delegating
- Delegate to 02-create-container.sh then 03-provision-container.sh

**3. Update cmd_delete with safety snapshot prompt:**
- Add validate_container_exists check
- Add prompt: "Create snapshot before deleting? [Y/n]:" (default yes)
- If yes, create snapshot with timestamp: `pre-delete-YYYYMMDD-HHMMSS`
- Then prompt: "Delete container '$name'? This cannot be undone. [y/N]:" (default no)
- Exit code 2 for user cancellation (not 0)

**4. Update cmd_restore with auto-snapshot and container stop:**
- Add validate_container_exists check
- Check if snapshot exists before proceeding
- Create automatic backup: `pre-restore-YYYYMMDD-HHMMSS`
- Stop container before restore (lxc stop with timeout 30)
- Then restore from specified snapshot
- Optionally restart container after restore

**5. Update cmd_shell, cmd_snapshot, cmd_info:**
- Add validate_container_exists check to each
- cmd_snapshot: Make snapshot name optional with default `manual-YYYYMMDD-HHMMSS`

**6. Standardize exit codes:**
- 0 = success
- 1 = error (validation failed, command failed)
- 2 = user cancelled (confirmation prompts)
  </action>
  <verify>
Run `bash -n sandbox.sh` to verify syntax is valid.
Run `./sandbox.sh help` to see updated usage.
Run `./sandbox.sh create` with no args to see proper usage message.
  </verify>
  <done>
All 7 commands updated with proper validation, confirmation prompts, and exit codes per CONTEXT.md decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update help text and finalize CLI</name>
  <files>sandbox.sh</files>
  <action>
**1. Update show_help() function:**
- Update create usage to show both arguments: `create <name> <tailscale-key>`
- Update snapshot to show optional label: `snapshot <name> [label]`
- Add note about exit codes
- Include examples for each command

**2. Update case statement for unknown commands:**
- Show full usage (not just "run help")
- Per CONTEXT.md: "Display all commands with descriptions on unknown command"

**3. Add --help flag support to individual commands:**
- Each command should check for --help and show command-specific usage

**4. Remove the redundant `ip` command:**
- The `info` command already shows Tailscale IP
- Keep CLI focused on the 7 required commands

**5. Final help text should match this format:**
```
Dev Sandbox Management

Usage: sandbox.sh <command> [arguments]

Commands:
  create <name> <tailscale-key>  Create and provision new sandbox
  shell <name>                   Open bash shell in container
  list                           List all sandboxes with status
  snapshot <name> [label]        Create named snapshot (default: auto-timestamp)
  restore <name> <label>         Restore from snapshot (auto-backups current state)
  delete <name>                  Delete container (prompts for confirmation)
  info <name>                    Show container details and Tailscale IP

Exit codes:
  0  Success
  1  Error (invalid arguments, command failed)
  2  User cancelled

Examples:
  sandbox.sh create relay-dev tskey-auth-xxxxx
  sandbox.sh shell relay-dev
  sandbox.sh snapshot relay-dev before-migration
  sandbox.sh restore relay-dev before-migration
  sandbox.sh delete relay-dev
```
  </action>
  <verify>
Run `./sandbox.sh` with no args to see full usage.
Run `./sandbox.sh badcommand` to verify it shows full usage (not just "run help").
Run `./sandbox.sh create --help` to verify command-specific help.
  </verify>
  <done>
Help text updated, unknown commands show full usage, all commands support --help flag.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify:

1. **Syntax check:** `bash -n sandbox.sh` passes
2. **Help display:** `./sandbox.sh` shows full usage with all 7 commands
3. **Unknown command:** `./sandbox.sh badcmd` shows full usage (not "run help")
4. **Create usage:** `./sandbox.sh create` shows "Usage: sandbox.sh create <name> <tailscale-key>"
5. **Exit codes documented:** Help text includes exit code section

Note: Full integration testing requires LXD host. Code review verification is sufficient for this phase.
</verification>

<success_criteria>
- [ ] sandbox.sh syntax valid (bash -n passes)
- [ ] create accepts name + auth key as arguments (not interactive)
- [ ] delete prompts for snapshot before deletion
- [ ] restore auto-snapshots current state before restoring
- [ ] restore stops container before restore operation
- [ ] All commands validate container existence before operating
- [ ] Exit codes: 0=success, 1=error, 2=cancelled
- [ ] Help text shows all 7 commands with examples
- [ ] Unknown command shows full usage
</success_criteria>

<output>
After completion, create `.planning/phases/04-management-cli/04-01-SUMMARY.md`
</output>
