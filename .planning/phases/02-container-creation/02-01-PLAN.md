---
phase: 02-container-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 02-create-container.sh
autonomous: true

must_haves:
  truths:
    - "Running ./02-create-container.sh with no args shows usage"
    - "Running ./02-create-container.sh with invalid name shows detailed error"
    - "Running ./02-create-container.sh relay-dev creates container"
    - "Created container has TUN device at /dev/net/tun"
    - "Created container has 4GB soft memory limit"
    - "Created container has CPUs matching host"
    - "Created container has network connectivity to internet"
    - "Created container has curl, git, ssh installed"
    - "Running again with same name prompts to replace"
    - "Replacing auto-snapshots existing container first"
  artifacts:
    - path: "02-create-container.sh"
      provides: "Container creation script"
      min_lines: 200
      exports: ["validate_container_name", "create_container", "wait_for_network"]
  key_links:
    - from: "02-create-container.sh"
      to: "lxc launch"
      via: "shell command"
      pattern: "lxc launch ubuntu:24.04"
    - from: "02-create-container.sh"
      to: "lxc config device add"
      via: "TUN device setup"
      pattern: "lxc config device add.*tun unix-char"
    - from: "02-create-container.sh"
      to: "lxc exec"
      via: "package installation"
      pattern: "lxc exec.*apt-get install"
---

<objective>
Create 02-create-container.sh that launches isolated LXC containers with proper networking, resource limits, and TUN device for Tailscale.

Purpose: Enable users to spin up new development sandboxes with a single command, each fully isolated and ready for provisioning.

Output: Executable bash script at 02-create-container.sh
</objective>

<context>
@/home/claude/projects/lxcsandbox/.planning/phases/02-container-creation/02-RESEARCH.md
@/home/claude/projects/lxcsandbox/.planning/phases/02-container-creation/02-CONTEXT.md
@/home/claude/projects/lxcsandbox/01-setup-host.sh
@/home/claude/projects/lxcsandbox/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create container script with validation and name handling</name>
  <files>02-create-container.sh</files>
  <action>
Create 02-create-container.sh with:

1. **Script header and setup** (follow 01-setup-host.sh patterns):
   - Shebang, description comments
   - `set -euo pipefail`
   - Error trap: `trap 'log_error "Script failed at line $LINENO"' ERR`
   - Color definitions (RED, GREEN, YELLOW, NC)
   - log_info, log_warn, log_error functions (same as 01-setup-host.sh)

2. **Argument handling**:
   - Check for exactly 1 argument
   - If missing: show usage message with example
   ```
   Usage: ./02-create-container.sh <container-name>
   Example: ./02-create-container.sh relay-dev
   ```

3. **validate_container_name function** (per RESEARCH.md Pattern 1):
   - Check length 2-30 characters
   - Check DNS-style format: `^[a-z][a-z0-9-]*[a-z0-9]$` (or `^[a-z][a-z0-9]$` for 2-char)
   - Check against reserved names: default, host, localhost, lxdbr0, none, self, all, container, lxc, lxd
   - On validation failure: detailed error message showing what's wrong + example of valid name

4. **Root check**:
   - Exit if not running as root (match 01-setup-host.sh pattern)

5. **handle_existing_container function** (per RESEARCH.md Pattern 4):
   - Check if container exists: `lxc info "$name" &> /dev/null`
   - If exists: prompt "Container 'name' already exists. Delete and create new? (y/N): "
   - If user says no: exit cleanly
   - If user confirms:
     - Create backup snapshot: `backup-YYYYMMDD-HHMMSS`
     - Stop container if running (30 second timeout)
     - Delete container with --force
     - Log the snapshot name so user can recover if needed
  </action>
  <verify>
Run validation checks:
```bash
# Should fail - no args
./02-create-container.sh 2>&1 | grep -q "Usage"

# Should fail - invalid name (starts with number)
./02-create-container.sh 123test 2>&1 | grep -q "lowercase letter"

# Should fail - reserved name
./02-create-container.sh localhost 2>&1 | grep -q "reserved"

# Should fail - too short
./02-create-container.sh x 2>&1 | grep -q "2-30 characters"
```
  </verify>
  <done>Script validates container names per DNS rules and handles existing containers with snapshot+prompt</done>
</task>

<task type="auto">
  <name>Task 2: Implement container creation with resource limits and TUN device</name>
  <files>02-create-container.sh</files>
  <action>
Add to 02-create-container.sh:

1. **create_container function** (per RESEARCH.md Pattern 2):
   ```bash
   create_container() {
       local name="$1"

       log_info "Launching container from ubuntu:24.04..."
       lxc launch ubuntu:24.04 "$name"

       # Get host CPU count
       local host_cpus
       host_cpus=$(nproc)

       log_info "Configuring resource limits..."

       # Soft memory limit (4GB, can burst)
       lxc config set "$name" limits.memory=4GB
       lxc config set "$name" limits.memory.enforce=soft
       lxc config set "$name" limits.memory.swap=true

       # Match host CPUs
       lxc config set "$name" limits.cpu="$host_cpus"

       log_info "Resource limits: 4GB soft memory, $host_cpus CPUs"
   }
   ```

2. **configure_tun_device function** (per RESEARCH.md Pattern 3):
   ```bash
   configure_tun_device() {
       local name="$1"

       log_info "Configuring TUN device for Tailscale..."

       # Enable nesting
       lxc config set "$name" security.nesting=true

       # Add TUN device
       lxc config device add "$name" tun unix-char path=/dev/net/tun

       log_info "TUN device configured"
   }
   ```

3. **Restart container after TUN device addition**:
   - IMPORTANT: TUN device requires restart to be available inside container
   - `lxc restart "$name"`
   - Brief pause to allow restart to complete

4. **Main script flow after validation passes**:
   ```
   handle_existing_container "$CONTAINER_NAME"
   create_container "$CONTAINER_NAME"
   configure_tun_device "$CONTAINER_NAME"
   lxc restart "$CONTAINER_NAME"
   ```
  </action>
  <verify>
```bash
# Create test container
sudo ./02-create-container.sh test-verify

# Check TUN device exists
sudo lxc exec test-verify -- ls -la /dev/net/tun

# Check memory limit
sudo lxc config get test-verify limits.memory  # Should show 4GB
sudo lxc config get test-verify limits.memory.enforce  # Should show soft

# Check CPU limit matches host
sudo lxc config get test-verify limits.cpu  # Should match $(nproc)

# Cleanup
sudo lxc delete test-verify --force
```
  </verify>
  <done>Container is created with 4GB soft memory limit, host-matching CPUs, and TUN device at /dev/net/tun</done>
</task>

<task type="auto">
  <name>Task 3: Implement network wait and basic package installation</name>
  <files>02-create-container.sh</files>
  <action>
Add to 02-create-container.sh:

1. **wait_for_network function** (per RESEARCH.md Pattern 5):
   - 60 second timeout (from CONTEXT.md decision)
   - Check BOTH IP address exists AND can ping 8.8.8.8
   - Show spinner during wait: `|/-\` characters
   - Clear spinner line on completion
   - On success: log IP address
   - On timeout: fail with error, show debug commands, leave container running
   ```bash
   wait_for_network() {
       local name="$1"
       local timeout=60
       local elapsed=0
       local spinstr='|/-\'

       echo -n "  Waiting for network connectivity..."

       while [[ $elapsed -lt $timeout ]]; do
           # Check for IP address
           local ip
           ip=$(lxc list "$name" --format csv -c 4 2>/dev/null | cut -d' ' -f1)

           if [[ -n "$ip" && "$ip" != "" ]]; then
               # Has IP, check internet
               if lxc exec "$name" -- ping -c 1 -W 2 8.8.8.8 &> /dev/null; then
                   printf "\r\033[K"  # Clear line
                   log_info "Network ready (IP: $ip)"
                   return 0
               fi
           fi

           # Spinner
           local temp=${spinstr#?}
           printf "\r  [%c] Waiting for network... (%ds/%ds)" "$spinstr" "$elapsed" "$timeout"
           spinstr=$temp${spinstr%"$temp"}

           sleep 1
           ((elapsed++))
       done

       printf "\r\033[K"
       log_error "Network connectivity failed after ${timeout}s"
       echo "Container left running for debugging:"
       echo "  lxc exec $name -- bash"
       echo "  lxc exec $name -- ip addr"
       echo "  lxc exec $name -- ping 8.8.8.8"
       return 1
   }
   ```

2. **install_basic_packages function** (per RESEARCH.md Pattern 6):
   - Wait for apt lock (cloud-init may be running)
   - Install: ca-certificates, curl, git, openssh-server, sudo
   - Enable and start SSH
   ```bash
   install_basic_packages() {
       local name="$1"

       log_info "Installing basic packages..."

       lxc exec "$name" -- bash -c '
           # Wait for apt lock
           while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
               sleep 1
           done

           apt-get update -qq

           DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
               ca-certificates \
               curl \
               git \
               openssh-server \
               sudo

           systemctl enable ssh
           systemctl start ssh
       '

       log_info "Basic packages installed"
   }
   ```

3. **Complete main script flow**:
   ```bash
   # Banner
   echo "=========================================="
   echo "Dev Sandbox - Container Creation"
   echo "=========================================="

   validate_container_name "$CONTAINER_NAME"
   handle_existing_container "$CONTAINER_NAME"
   create_container "$CONTAINER_NAME"
   configure_tun_device "$CONTAINER_NAME"

   log_info "Restarting container to apply TUN device..."
   lxc restart "$CONTAINER_NAME"
   sleep 2  # Allow restart to settle

   wait_for_network "$CONTAINER_NAME"
   install_basic_packages "$CONTAINER_NAME"

   # Success summary
   echo ""
   echo "=========================================="
   echo "Container '$CONTAINER_NAME' created!"
   echo "=========================================="
   echo ""
   echo "Next step:"
   echo "  ./03-provision-container.sh $CONTAINER_NAME <tailscale-authkey>"
   echo ""
   echo "Quick access:"
   echo "  lxc exec $CONTAINER_NAME -- bash"
   echo ""
   ```

4. **Make script executable**: `chmod +x 02-create-container.sh`
  </action>
  <verify>
Full integration test:
```bash
# Create a real container
sudo ./02-create-container.sh integration-test

# Verify network
sudo lxc exec integration-test -- ping -c 1 8.8.8.8

# Verify packages
sudo lxc exec integration-test -- which curl
sudo lxc exec integration-test -- which git
sudo lxc exec integration-test -- systemctl status ssh | grep "active (running)"

# Verify TUN
sudo lxc exec integration-test -- ls /dev/net/tun

# Test replacement flow (will prompt)
echo "y" | sudo ./02-create-container.sh integration-test

# Verify snapshot was created
sudo lxc info integration-test | grep -A5 Snapshots

# Cleanup
sudo lxc delete integration-test --force
```
  </verify>
  <done>Script waits for network with spinner, installs basic packages, and shows success summary with next steps</done>
</task>

</tasks>

<verification>
Complete phase verification:

```bash
# 1. Script exists and is executable
test -x ./02-create-container.sh && echo "PASS: Script executable"

# 2. Create fresh container
sudo ./02-create-container.sh verify-phase

# 3. All requirements met
sudo lxc exec verify-phase -- ls /dev/net/tun && echo "PASS: TUN device"
sudo lxc config get verify-phase limits.memory | grep -q "4GB" && echo "PASS: Memory limit"
sudo lxc config get verify-phase limits.memory.enforce | grep -q "soft" && echo "PASS: Soft limit"
sudo lxc exec verify-phase -- which curl && echo "PASS: curl installed"
sudo lxc exec verify-phase -- which git && echo "PASS: git installed"
sudo lxc exec verify-phase -- systemctl is-active ssh && echo "PASS: SSH running"
sudo lxc exec verify-phase -- ping -c 1 8.8.8.8 && echo "PASS: Internet connectivity"

# 4. Cleanup
sudo lxc delete verify-phase --force
```
</verification>

<success_criteria>
- CONT-01: Script accepts container name as argument (usage shown without args)
- CONT-02: Script validates container name format (DNS-style, reserved names blocked)
- CONT-03: Script launches Ubuntu 24.04 container from image
- CONT-04: Script adds TUN device to container for Tailscale
- CONT-05: Script sets memory limit (4GB soft)
- CONT-06: Script sets CPU limit (matches host cores)
- CONT-07: Script waits for container network connectivity (60s timeout, spinner, debug on fail)
- CONT-08: Script installs basic packages (curl, git, ssh)
- BONUS: Existing container handling with auto-snapshot before replacement
</success_criteria>

<output>
After completion, create `.planning/phases/02-container-creation/02-01-SUMMARY.md`
</output>
