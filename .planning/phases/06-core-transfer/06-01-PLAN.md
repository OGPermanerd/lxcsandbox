---
phase: 06-core-transfer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 04-migrate-project.sh
autonomous: true

must_haves:
  truths:
    - "Git URL source (https or git@) triggers git clone inside container"
    - "Local directory path triggers tar pipe transfer with exclusions"
    - "--branch flag is passed to git clone when specified"
    - "Project files appear in /root/projects/<name> inside container"
    - "node_modules and .git are never transferred from local copies"
    - ".env file is copied from source to container project directory"
  artifacts:
    - path: "04-migrate-project.sh"
      provides: "Project file transfer to LXC containers"
      min_lines: 150
      contains: ["detect_source_type", "clone_git_repository", "copy_local_directory", "copy_env_file"]
  key_links:
    - from: "04-migrate-project.sh"
      to: "lxc exec"
      via: "container_exec helper"
      pattern: "lxc exec.*--.*bash"
    - from: "detect_source_type"
      to: "clone_git_repository OR copy_local_directory"
      via: "case statement routing"
      pattern: "case.*source_type.*git.*local"
    - from: "copy_local_directory"
      to: "tar pipe to container"
      via: "tar -c | lxc exec tar -x"
      pattern: "tar.*exclude.*node_modules.*lxc exec.*tar"
---

<objective>
Create 04-migrate-project.sh that transfers project source code into LXC containers via git clone or local copy.

Purpose: This is the foundation for project migration - getting source files into the container. Later phases (7-9) will handle dependencies, databases, and CLI integration.

Output: Working 04-migrate-project.sh script that:
- Detects source type (git URL vs local path)
- Clones git repos directly inside container with optional --branch
- Copies local directories via tar pipe, excluding node_modules and .git
- Copies .env file separately (it may be gitignored)
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-core-transfer/06-RESEARCH.md
@03-provision-container.sh (pattern reference for logging, error handling, container_exec)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create script structure with source detection</name>
  <files>04-migrate-project.sh</files>
  <action>
Create 04-migrate-project.sh following the established pattern from 03-provision-container.sh:

**Header section:**
- Shebang, description, usage example
- Usage: `./04-migrate-project.sh <container-name> <source> [--branch <branch>]`
- Example: `./04-migrate-project.sh relay-dev https://github.com/user/project.git --branch main`
- Example: `./04-migrate-project.sh relay-dev /path/to/local/project`

**Standard boilerplate (copy from 03-provision-container.sh):**
- `set -euo pipefail`
- Trap for ERR with line number
- Color constants (RED, GREEN, YELLOW, NC)
- log_info, log_warn, log_error functions
- Root check

**Argument parsing:**
- CONTAINER_NAME="$1"
- SOURCE="$2"
- Parse optional `--branch` flag from remaining args
- Store in BRANCH variable (empty if not specified)

**Validation:**
- Check container exists (same pattern as 03-provision)
- Validate SOURCE is not empty

**Source detection function (from RESEARCH.md):**
```bash
detect_source_type() {
    local source="$1"

    if [[ -z "$source" ]]; then
        echo "unknown"
        return 1
    fi

    # Git URL patterns (HTTPS, SSH, git protocol)
    if [[ "$source" =~ ^https?:// ]] && [[ "$source" =~ (\.git$|github\.com|gitlab\.com|bitbucket\.org) ]]; then
        echo "git"
        return 0
    fi

    if [[ "$source" =~ ^git@ ]] || \
       [[ "$source" =~ ^ssh:// ]] || \
       [[ "$source" =~ ^git:// ]]; then
        echo "git"
        return 0
    fi

    # Local path (must exist as directory)
    if [[ -d "$source" ]]; then
        echo "local"
        return 0
    fi

    # Fallback: HTTPS URL without .git might still be git
    if [[ "$source" =~ ^https?:// ]]; then
        echo "git"
        return 0
    fi

    echo "unknown"
    return 1
}
```

**Project name derivation (from RESEARCH.md):**
```bash
derive_project_name() {
    local source="$1"

    # From git URL with .git suffix
    if [[ "$source" =~ \.git$ ]]; then
        basename "$source" .git
        return 0
    fi

    # From git URL without .git (github/gitlab style)
    if [[ "$source" =~ ^https?:// ]] || [[ "$source" =~ ^git@ ]]; then
        basename "$source"
        return 0
    fi

    # From local path (resolve to absolute first)
    basename "$(cd "$source" && pwd)"
}
```

**container_exec helper (same as 03-provision):**
```bash
container_exec() {
    lxc exec "$CONTAINER_NAME" -- bash -c "$1"
}
```
  </action>
  <verify>
`bash -n 04-migrate-project.sh` shows no syntax errors.
Running `./04-migrate-project.sh` with no args shows usage message.
  </verify>
  <done>
Script exists with proper header, argument parsing, source detection, and helper functions. No syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement transfer functions</name>
  <files>04-migrate-project.sh</files>
  <action>
Add the transfer functions after the helper functions section:

**Git clone function (from RESEARCH.md):**
```bash
clone_git_repository() {
    local repo_url="$1"
    local dest_dir="$2"
    local branch="${3:-}"

    log_info "Cloning repository into container..."

    if [[ -n "$branch" ]]; then
        log_info "Using branch/tag: $branch"
        container_exec "git clone --branch '$branch' '$repo_url' '$dest_dir'"
    else
        container_exec "git clone '$repo_url' '$dest_dir'"
    fi

    # Verify clone succeeded
    if ! lxc exec "$CONTAINER_NAME" -- test -d "$dest_dir/.git"; then
        log_error "Git clone failed - no .git directory found"
        return 1
    fi

    log_info "Repository cloned to $dest_dir"
}
```

**Local directory copy function (from RESEARCH.md):**
```bash
copy_local_directory() {
    local source_dir="$1"
    local dest_dir="$2"

    log_info "Copying project files (excluding node_modules, .git)..."

    # Convert to absolute path for tar
    local abs_source
    abs_source="$(cd "$source_dir" && pwd)"

    # Create destination directory
    container_exec "mkdir -p '$dest_dir'"

    # Use tar pipe for reliable transfer with exclusions
    # Key: --exclude before -cf, and use . as source (not path)
    tar -C "$abs_source" \
        --exclude='node_modules' \
        --exclude='.git' \
        --exclude='dist' \
        --exclude='build' \
        --exclude='.next' \
        --exclude='.nuxt' \
        --exclude='.cache' \
        --exclude='coverage' \
        -cf - . | lxc exec "$CONTAINER_NAME" -- tar -C "$dest_dir" -xf -

    log_info "Project copied to $CONTAINER_NAME:$dest_dir"
}
```

**Env file copy function (from RESEARCH.md):**
```bash
copy_env_file() {
    local source_dir="$1"
    local dest_dir="$2"

    # Convert to absolute path
    local abs_source
    abs_source="$(cd "$source_dir" && pwd)"

    if [[ -f "$abs_source/.env" ]]; then
        log_info "Copying .env file..."
        lxc file push "$abs_source/.env" "$CONTAINER_NAME$dest_dir/.env"
        log_info ".env copied to container"
    else
        log_warn "No .env file found in source"
        if [[ -f "$abs_source/.env.example" ]]; then
            log_info ".env.example exists - will be handled in later phase"
        fi
    fi
}
```

**Important details:**
- Use single quotes inside container_exec strings to handle paths with spaces
- The tar excludes use --exclude before -cf (order matters)
- lxc file push path format: `container_name/path/inside` (no colon)
  </action>
  <verify>
`bash -n 04-migrate-project.sh` shows no syntax errors.
`grep -c 'exclude' 04-migrate-project.sh` returns at least 6 (node_modules, .git, dist, build, .next, .nuxt, .cache, coverage)
  </verify>
  <done>
Transfer functions exist: clone_git_repository, copy_local_directory, copy_env_file. All use correct lxc patterns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement main orchestration and complete script</name>
  <files>04-migrate-project.sh</files>
  <action>
Add the main transfer orchestration function and final execution block:

**Main transfer function:**
```bash
transfer_project() {
    local source_type
    source_type=$(detect_source_type "$SOURCE")

    local project_name
    project_name=$(derive_project_name "$SOURCE")
    local dest_dir="/root/projects/$project_name"

    log_info "=== Project Migration ==="
    log_info "Container: $CONTAINER_NAME"
    log_info "Source: $SOURCE"
    log_info "Source type: $source_type"
    log_info "Destination: $dest_dir"
    [[ -n "${BRANCH:-}" ]] && log_info "Branch: $BRANCH"
    echo ""

    # Create projects directory
    container_exec "mkdir -p /root/projects"

    case "$source_type" in
        git)
            clone_git_repository "$SOURCE" "$dest_dir" "${BRANCH:-}"
            ;;
        local)
            copy_local_directory "$SOURCE" "$dest_dir"
            # For local copy, also copy .env if it exists
            copy_env_file "$SOURCE" "$dest_dir"
            ;;
        *)
            log_error "Unknown source type: $SOURCE"
            log_error "Source must be a git URL or existing local directory"
            exit 1
            ;;
    esac

    # Verify transfer succeeded
    if ! lxc exec "$CONTAINER_NAME" -- test -d "$dest_dir"; then
        log_error "Transfer failed - destination directory not created"
        exit 1
    fi

    # Show what was transferred
    echo ""
    log_info "=== Transfer Complete ==="
    log_info "Project location: $CONTAINER_NAME:$dest_dir"
    echo ""
    echo "Files in project root:"
    lxc exec "$CONTAINER_NAME" -- ls -la "$dest_dir" | head -15

    echo ""
    log_info "Next steps (run inside container):"
    echo "  lxc exec $CONTAINER_NAME -- bash"
    echo "  cd $dest_dir"
    echo "  npm install  # or yarn/pnpm"
}
```

**Execution block at end of script:**
```bash
# -------------------------------------------
# Main Execution
# -------------------------------------------

log_info "Starting project migration..."
transfer_project
log_info "Migration phase 1 (file transfer) complete!"
```

**Make script executable:**
The executor should run `chmod +x 04-migrate-project.sh` after creating the file.
  </action>
  <verify>
`bash -n 04-migrate-project.sh` passes (no syntax errors).
`chmod +x 04-migrate-project.sh` makes it executable.
The script shows usage when run without arguments.
`grep 'transfer_project' 04-migrate-project.sh` shows the function is called in main execution.
  </verify>
  <done>
Complete script with:
- Main orchestration function that routes to git or local transfer
- Final execution block that runs the transfer
- Executable permissions set
- Usage message shows when run without args
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax check:** `bash -n 04-migrate-project.sh` exits 0
2. **Executable:** `ls -la 04-migrate-project.sh` shows -rwxr-xr-x
3. **Usage message:** `./04-migrate-project.sh` (no args) shows usage with examples
4. **Required functions exist:**
   - `grep -c 'detect_source_type' 04-migrate-project.sh` >= 2 (definition + call)
   - `grep -c 'clone_git_repository' 04-migrate-project.sh` >= 2
   - `grep -c 'copy_local_directory' 04-migrate-project.sh` >= 2
   - `grep -c 'copy_env_file' 04-migrate-project.sh` >= 2
5. **Exclusions present:** `grep 'exclude.*node_modules' 04-migrate-project.sh`
6. **Branch flag:** `grep '\-\-branch' 04-migrate-project.sh`
7. **Dest path:** `grep '/root/projects' 04-migrate-project.sh`

Note: Full integration testing requires an actual LXD host with containers. This phase delivers the script; testing happens when deployed.
</verification>

<success_criteria>
- 04-migrate-project.sh exists and passes bash syntax check
- Script follows established pattern from 03-provision-container.sh (logging, error handling)
- Source detection identifies git URLs vs local paths
- Git clone supports --branch flag for branch/tag specification
- Local copy uses tar pipe with node_modules and .git excluded
- .env file is copied separately for local sources
- Destination is always /root/projects/<project-name>
- Usage message is shown when run without arguments
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-transfer/06-01-SUMMARY.md`
</output>
