---
phase: 09-cli-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sandbox.sh
  - 04-migrate-project.sh
autonomous: true

must_haves:
  truths:
    - "User can run sandbox.sh migrate <container> <source> end-to-end"
    - "Pre-migration snapshot is created automatically before changes"
    - "Existing project prompts user or respects --force flag"
    - "Success output shows rollback hint and next steps"
    - "Error output includes snapshot name for rollback"
    - "Migration summary displays detected package manager, Node version, database name, and migration tool"
  artifacts:
    - path: "sandbox.sh"
      provides: "cmd_migrate function and updated help"
      contains: "cmd_migrate"
    - path: "04-migrate-project.sh"
      provides: "--force flag, existence check, and migration summary"
      contains: "check_existing_project"
    - path: "04-migrate-project.sh"
      provides: "print_migration_summary function"
      contains: "print_migration_summary"
  key_links:
    - from: "sandbox.sh cmd_migrate"
      to: "04-migrate-project.sh"
      via: "delegation with args pass-through"
      pattern: '04-migrate-project\.sh.*"\$container".*"\$source"'
    - from: "sandbox.sh"
      to: "lxc snapshot"
      via: "pre-migration safety"
      pattern: "lxc snapshot.*pre-migrate"
    - from: "transfer_project"
      to: "print_migration_summary"
      via: "summary output at end of successful migration"
      pattern: "print_migration_summary"
---

<objective>
Integrate migrate command into sandbox.sh CLI with safety features and polished UX

Purpose: Users access migration through the unified CLI with automatic safety snapshots, re-migration detection, and clear feedback - no need to call backend scripts directly.

Output: Updated sandbox.sh with migrate command, updated 04-migrate-project.sh with --force flag, existence check, and migration summary
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cli-integration/09-RESEARCH.md

# Reference existing implementation
@sandbox.sh
@04-migrate-project.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --force flag, existence check, and migration summary to 04-migrate-project.sh</name>
  <files>04-migrate-project.sh</files>
  <action>
Update 04-migrate-project.sh to support project existence detection, --force override, and migration summary output:

1. Add --force flag parsing alongside --branch:
   - Add FORCE="" variable after BRANCH=""
   - In the while loop, add case for --force (set FORCE="true", shift 1)

2. Add check_existing_project() function after derive_project_name():
```bash
# Check if project already exists at destination
check_existing_project() {
    local dest_dir="$1"
    if lxc exec "$CONTAINER_NAME" -- test -d "$dest_dir"; then
        return 0  # Exists
    fi
    return 1  # Does not exist
}
```

3. In transfer_project(), after defining dest_dir, add existence check:
```bash
# Check for existing project
if check_existing_project "$dest_dir"; then
    if [[ "$FORCE" == "true" ]]; then
        log_warn "Project exists at $dest_dir - removing for re-migration (--force)"
        container_exec "rm -rf '$dest_dir'"
    else
        log_error "Project already exists at $dest_dir"
        echo ""
        echo "Options:"
        echo "  1. Use --force to overwrite: ./04-migrate-project.sh $CONTAINER_NAME $SOURCE --force"
        echo "  2. Delete manually: lxc exec $CONTAINER_NAME -- rm -rf $dest_dir"
        echo ""
        exit 1
    fi
fi
```

4. Add print_migration_summary() function after check_existing_project():
```bash
# Print migration summary showing what was detected and done
print_migration_summary() {
    local project_name="$1"
    local pkg_manager="$2"
    local node_version="$3"
    local db_name="$4"
    local migration_tool="$5"

    echo ""
    echo "=========================================="
    echo "         MIGRATION SUMMARY"
    echo "=========================================="
    echo ""
    echo "Project:          $project_name"
    echo "Package Manager:  ${pkg_manager:-none detected}"
    echo "Node Version:     ${node_version:-not installed}"
    echo "Database Created: ${db_name:-none}"
    echo "Migration Tool:   ${migration_tool:-none}"
    echo ""
    echo "=========================================="
}
```

5. In transfer_project(), track detected values throughout the function:
   - After package manager detection: store in PKG_MANAGER variable
   - After database creation: store DB_NAME (already exists as db_name)
   - After migration tool detection: store MIGRATION_TOOL (prisma/drizzle/sql/none)
   - Get Node version: NODE_VERSION=$(container_exec "node --version 2>/dev/null || echo 'not installed'")

6. At the end of transfer_project() (just before the final success message), call:
```bash
# Get node version for summary
NODE_VERSION=$(container_exec "node --version 2>/dev/null" || echo "not installed")

# Print migration summary
print_migration_summary "$PROJECT_NAME" "$PKG_MANAGER" "$NODE_VERSION" "$db_name" "$MIGRATION_TOOL"
```

7. Update the usage text at top to include --force option:
   - Add line: "  --force           Force re-migration (delete existing project first)"

8. Update help examples to show --force usage.
  </action>
  <verify>
- `bash -n 04-migrate-project.sh` passes (syntax check)
- `./04-migrate-project.sh --help 2>&1 | grep -q '\-\-force'` shows --force in help
- `grep -q 'check_existing_project' 04-migrate-project.sh` confirms function exists
- `grep -q 'print_migration_summary' 04-migrate-project.sh` confirms summary function exists
- `grep -q 'MIGRATION SUMMARY' 04-migrate-project.sh` confirms summary output block
  </verify>
  <done>
- 04-migrate-project.sh accepts --force flag
- Script checks for existing project before migration
- Without --force, existing project causes exit 1 with clear message
- With --force, existing project is removed and migration proceeds
- Migration summary printed at end showing: package manager detected, Node version, database name, migration tool used
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cmd_migrate to sandbox.sh with safety features</name>
  <files>sandbox.sh</files>
  <action>
Update sandbox.sh to include migrate command with pre-migration snapshots and UX polish:

1. Add cmd_migrate() function after cmd_info():
```bash
cmd_migrate() {
    local container="${1:-}"
    local source="${2:-}"

    # Validate arguments
    if [[ -z "$container" || -z "$source" ]]; then
        echo "Usage: $0 migrate <container> <source> [--branch <branch>] [--force]"
        echo ""
        echo "Migrate a project into a sandbox container."
        echo ""
        echo "Arguments:"
        echo "  container    Name of existing LXC container"
        echo "  source       Git URL or local directory path"
        echo ""
        echo "Options:"
        echo "  --branch <branch>   Clone specific branch or tag (git sources only)"
        echo "  --force             Force re-migration if project already exists"
        echo ""
        echo "Examples:"
        echo "  sudo $0 migrate relay-dev https://github.com/user/project.git"
        echo "  sudo $0 migrate relay-dev /home/user/myproject"
        echo "  sudo $0 migrate relay-dev https://github.com/user/repo.git --branch main"
        echo "  sudo $0 migrate relay-dev https://github.com/user/repo.git --force"
        exit 1
    fi

    # Root check (04-migrate-project.sh requires root)
    if [[ $EUID -ne 0 ]]; then
        echo "Error: migrate command requires root (or sudo)"
        echo "Usage: sudo $0 migrate <container> <source>"
        exit 1
    fi

    # Validate container exists
    validate_container_exists "$container"

    shift 2  # Remove container and source from args

    # Create pre-migration snapshot
    local snapshot_label="pre-migrate-$(date +%Y%m%d-%H%M%S)"
    echo -e "${CYAN}Creating pre-migration snapshot: $snapshot_label${NC}"
    lxc snapshot "$container" "$snapshot_label"

    # Delegate to migration script (handles file transfer, deps, database)
    # Pass remaining args for --branch and --force support
    if ! "$SCRIPT_DIR/04-migrate-project.sh" "$container" "$source" "$@"; then
        echo ""
        echo -e "${RED}[ERROR]${NC} Migration failed"
        echo ""
        echo "To rollback to pre-migration state:"
        echo "  $0 restore $container $snapshot_label"
        exit 1
    fi

    # Success - show snapshot info
    echo ""
    echo -e "${GREEN}Pre-migration snapshot available:${NC} $snapshot_label"
    echo "To rollback if needed: $0 restore $container $snapshot_label"
}
```

2. Add RED color definition after existing colors (line ~15):
```bash
RED='\033[0;31m'
```

3. Update show_help() to include migrate command:
   - Add after "create" line:
     `echo "  migrate <name> <source>        Migrate project into sandbox (creates snapshot first)"`
   - Add in Examples section:
     ```
     echo "  sudo $0 migrate relay-dev https://github.com/user/project.git"
     ```

4. Add migrate case to main switch statement (after create case):
```bash
    migrate)
        cmd_migrate "$@"
        ;;
```
  </action>
  <verify>
- `bash -n sandbox.sh` passes (syntax check)
- `./sandbox.sh --help | grep -q migrate` shows migrate in help
- `./sandbox.sh migrate` shows usage with examples
- `grep -q 'cmd_migrate' sandbox.sh` confirms function exists
- `grep -q 'pre-migrate' sandbox.sh` confirms snapshot creation
  </verify>
  <done>
- sandbox.sh has migrate command
- `./sandbox.sh migrate` shows proper usage
- Root check happens before any operations
- Pre-migration snapshot created automatically
- All optional flags (--branch, --force) passed through to backend
- Clear error message with rollback instructions on failure
- Success message shows snapshot name for potential rollback
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify end-to-end integration:

1. Syntax validation:
   - `bash -n sandbox.sh && bash -n 04-migrate-project.sh` - both pass

2. Help text completeness:
   - `./sandbox.sh --help` shows migrate command
   - `./sandbox.sh migrate` shows detailed usage

3. Code structure verification:
   - `grep -c 'cmd_' sandbox.sh` shows 8 commands (list, create, delete, shell, snapshot, restore, info, migrate)
   - `grep 'case.*migrate' sandbox.sh` shows migrate in switch statement
   - `grep '\-\-force' 04-migrate-project.sh` shows force flag handling

4. Integration points:
   - `grep '04-migrate-project' sandbox.sh` confirms delegation
   - `grep 'lxc snapshot.*pre-migrate' sandbox.sh` confirms safety snapshot

5. Migration summary verification:
   - `grep 'print_migration_summary' 04-migrate-project.sh` confirms function exists
   - `grep 'MIGRATION SUMMARY' 04-migrate-project.sh` confirms summary output
   - `grep 'Package Manager' 04-migrate-project.sh` confirms summary includes pkg manager
   - `grep 'Node Version' 04-migrate-project.sh` confirms summary includes node version
   - `grep 'Migration Tool' 04-migrate-project.sh` confirms summary includes migration tool
</verification>

<success_criteria>
- sandbox.sh migrate command works with all argument combinations
- Pre-migration snapshot created before any container modifications
- Existing project detection works (--force to override)
- Clear success/error messages with rollback hints
- Help text documents all options and provides examples
- Both scripts pass bash -n syntax validation
- Migration summary displays: package manager, Node version, database name, migration tool
</success_criteria>

<output>
After completion, create `.planning/phases/09-cli-integration/09-01-SUMMARY.md`
</output>
